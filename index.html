<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†çµ„é»é»å</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&family=LXGW+WenKai+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .signature-font {
            font-family: 'LXGW WenKai TC', serif;
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        .name-display {
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            transition: all 0.1s;
        }
        .glow-btn {
            transition: all 0.3s ease;
        }
        .glow-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        .glow-btn:active {
            transform: translateY(1px);
        }
        textarea::-webkit-scrollbar { width: 8px; }
        textarea::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        textarea::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        textarea::-webkit-scrollbar-thumb:hover { background: #555; }
        
        .animate-pop { animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        
        .group-card { animation: slideIn 0.4s ease-out forwards; opacity: 0; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .sound-btn.active svg { fill: currentColor; }
        .sound-btn.muted svg { fill: none; opacity: 0.5; }

        .modal-enter { opacity: 0; transform: scale(0.9); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: all 0.2s ease-out; }
        .modal-exit { opacity: 1; transform: scale(1); }
        .modal-exit-active { opacity: 0; transform: scale(0.9); transition: all 0.2s ease-in; }

        .wheel-shadow { filter: drop-shadow(0 10px 15px rgba(0, 0, 0, 0.3)); }
        .pointer-shadow { filter: drop-shadow(0 4px 6px rgba(0,0,0,0.4)); }

        .score-pop { animation: scorePop 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes scorePop { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }

        .timer-circle {
            transform: rotate(-90deg);
            transition: stroke-dashoffset 1s linear;
        }
        .timer-text {
            font-variant-numeric: tabular-nums;
        }
        .timer-danger {
            animation: pulse-red 1s infinite alternate;
        }
        @keyframes pulse-red {
            from { color: #f43f5e; }
            to { color: #9f1239; transform: scale(1.05); }
        }

        /* ä¿®æ­£è¦åŠƒï¼šè¢«æŠ½éçš„äººå“¡æ”¹ç‚ºã€Œé«˜äº®è®Šç²—ã€æ¨£å¼ï¼Œä¸å†è®Šç° */
        .picked-member {
            color: #be123c !important; /* Rose-700 */
            background-color: #fff1f2; /* Rose-50 */
            font-weight: 900 !important;
            border-radius: 4px;
            padding: 2px 4px;
            box-shadow: 0 0 0 1px #fecdd3; /* Rose-200 border */
            transition: all 0.5s ease;
        }
    </style>
</head>
<body class="flex items-center justify-center p-4">

    <!-- éŸ³æ•ˆè³‡æº -->
    <audio id="sound-roll" loop src="https://assets.mixkit.co/active_storage/sfx/2044/2044-preview.mp3"></audio>
    <audio id="sound-win" src="https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3"></audio>
    <audio id="sound-alarm" src="https://assets.mixkit.co/active_storage/sfx/1004/1004-preview.mp3"></audio>

    <!-- Main Container -->
    <div class="glass-panel w-full max-w-4xl rounded-2xl overflow-hidden flex flex-col shadow-2xl h-[90vh] md:h-auto md:min-h-[700px]">
        
        <!-- Header & Top Toolbar -->
        <div class="flex justify-between items-center p-4 md:px-8 border-b border-gray-100 bg-white/50">
            <h1 class="text-2xl font-black text-indigo-600 flex items-center gap-2 cursor-pointer select-none" onclick="window.location.reload()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
                åˆ†çµ„é»é»å
            </h1>
            
            <div class="flex gap-2">
                <button onclick="showTimerView()" class="p-2 rounded-full bg-rose-50 hover:bg-rose-100 text-rose-600 transition tooltip-container relative group" title="è¨ˆæ™‚å™¨">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </button>
                <button onclick="openEditModal()" class="p-2 rounded-full bg-indigo-50 hover:bg-indigo-100 text-indigo-600 transition relative group" title="ç·¨è¼¯åå–®">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                    </svg>
                </button>
                <button id="wakeLockBtn" onclick="toggleWakeLock()" class="p-2 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-500 transition relative group" title="é˜²æ­¢è¢å¹•ä¼‘çœ ">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                    </svg>
                </button>
                <button id="soundBtn" onclick="toggleSound()" class="sound-btn active p-2 rounded-full bg-indigo-50 hover:bg-indigo-100 text-indigo-600 transition relative group" title="é–‹é—œéŸ³æ•ˆ">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM14.657 2.929a1 1 0 011.414 0A9.972 9.972 0 0119 10a9.972 9.972 0 01-2.929 7.071 1 1 0 01-1.414-1.414A7.971 7.971 0 0017 10c0-2.21-.894-4.208-2.343-5.657a1 1 0 010-1.414zm-2.829 2.828a1 1 0 011.415 0A5.983 5.983 0 0115 10a5.984 5.984 0 01-1.757 4.243 1 1 0 01-1.415-1.415A3.984 3.984 0 0013 10a3.983 3.983 0 00-1.172-2.828 1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- Main Display Area -->
        <div class="flex-1 px-4 py-6 md:px-8 flex flex-col bg-white relative overflow-y-auto overflow-x-hidden">
            
            <!-- å–®äººæŠ½ç±¤è¦–åœ– -->
            <div id="singleView" class="flex-1 flex flex-col items-center justify-center w-full transition-opacity duration-300">
                <div id="resultCard" class="relative w-full aspect-video md:aspect-auto md:h-64 flex items-center justify-center bg-gradient-to-br from-indigo-50 to-blue-50 rounded-2xl border-2 border-indigo-100 mb-8 p-4 text-center overflow-hidden">
                    <div id="displayName" class="name-display text-5xl md:text-7xl font-black text-gray-300 select-none break-all">READY?</div>
                    <div id="statusText" class="absolute bottom-2 text-sm text-gray-400 font-medium tracking-widest uppercase">ç­‰å¾…é–‹å§‹</div>
                </div>

                <button id="actionBtn" onclick="toggleRoll()" class="glow-btn w-full max-w-sm py-4 rounded-xl bg-gradient-to-r from-indigo-600 to-purple-600 text-white text-2xl font-bold tracking-wider shadow-lg hover:shadow-indigo-500/50 flex items-center justify-center gap-3">
                    <svg id="playIcon" xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    <span id="btnText">é–‹å§‹é»å</span>
                </button>

                <div class="mt-8 w-full max-w-lg text-center">
                    <div class="flex justify-between items-end mb-2 border-b border-gray-100 pb-1">
                        <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">æœ¬è¼ªå·²æŠ½å‡º (<span id="historyCount">0</span>)</span>
                        <button onclick="clearHistory()" class="text-xs text-gray-400 hover:text-red-500 transition-colors">æ¸…é™¤ç´€éŒ„</button>
                    </div>
                    <div id="historyList" class="flex flex-wrap gap-2 justify-center min-h-[2rem] max-h-[100px] overflow-y-auto p-2 bg-gray-50 rounded-lg border border-gray-100">
                        <span class="text-xs text-gray-400 italic py-1">å°šæœªé–‹å§‹é»å</span>
                    </div>
                </div>
            </div>

            <!-- è¨ˆæ™‚å™¨è¦–åœ– -->
            <div id="timerView" class="hidden flex-1 flex flex-col items-center justify-center w-full transition-opacity duration-300">
                <div class="w-full flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-800">å€’æ•¸è¨ˆæ™‚å™¨</h2>
                    <div class="flex gap-2">
                        <button id="timerToScoreBtn" onclick="showScoreView()" class="px-3 py-1.5 text-sm bg-yellow-50 hover:bg-yellow-100 text-yellow-700 rounded-lg transition font-bold hidden">è¿”å›è¨ˆåˆ†æ¿</button>
                        <button onclick="showSingleView()" class="px-3 py-1.5 text-sm bg-indigo-50 hover:bg-indigo-100 text-indigo-600 rounded-lg transition font-bold">è¿”å›æŠ½ç±¤</button>
                    </div>
                </div>
                <div class="relative w-64 h-64 md:w-80 md:h-80 flex items-center justify-center">
                    <svg class="absolute inset-0 w-full h-full" viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="45" stroke="#f1f5f9" stroke-width="6" fill="none" />
                        <circle id="timerProgress" cx="50" cy="50" r="45" stroke="#6366f1" stroke-width="6" fill="none" stroke-dasharray="282.7" stroke-dashoffset="0" stroke-linecap="round" class="timer-circle" />
                    </svg>
                    <div id="timerDisplay" class="timer-text text-6xl md:text-7xl font-black text-gray-800">01:00</div>
                </div>
                <div class="flex flex-wrap justify-center gap-2 mt-8 mb-6">
                    <button onclick="setTimer(60)" class="px-4 py-2 bg-indigo-50 text-indigo-600 rounded-full text-sm font-bold hover:bg-indigo-100 transition">1 åˆ†é˜</button>
                    <button onclick="setTimer(180)" class="px-4 py-2 bg-indigo-50 text-indigo-600 rounded-full text-sm font-bold hover:bg-indigo-100 transition">3 åˆ†é˜</button>
                    <button onclick="setTimer(300)" class="px-4 py-2 bg-indigo-50 text-indigo-600 rounded-full text-sm font-bold hover:bg-indigo-100 transition">5 åˆ†é˜</button>
                    <button onclick="setTimer(600)" class="px-4 py-2 bg-indigo-50 text-indigo-600 rounded-full text-sm font-bold hover:bg-indigo-100 transition">10 åˆ†é˜</button>
                </div>
                <div class="flex gap-4">
                    <button id="timerToggleBtn" onclick="toggleTimer()" class="px-8 py-3 bg-indigo-600 text-white rounded-xl font-bold shadow-lg shadow-indigo-200 hover:scale-105 active:scale-95 transition">é–‹å§‹</button>
                    <button onclick="resetTimer()" class="px-8 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold hover:bg-gray-200 active:scale-95 transition">é‡ç½®</button>
                </div>
            </div>

            <!-- åˆ†çµ„çµæœè¦–åœ– -->
            <div id="groupView" class="hidden flex-col w-full flex-1">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 border-b border-gray-100 pb-4 gap-4 md:gap-0">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0z" /></svg>åˆ†çµ„çµæœ
                    </h2>
                    <div class="flex gap-2 w-full md:w-auto">
                        <button onclick="showScoreView()" class="flex-1 md:flex-none justify-center px-3 py-1.5 text-sm bg-yellow-50 hover:bg-yellow-100 text-yellow-700 rounded-lg transition flex items-center gap-1 font-bold">åˆ‡æ›è¨ˆåˆ†æ¿</button>
                        <button onclick="copyGroups()" class="flex-1 md:flex-none justify-center px-3 py-1.5 text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition flex items-center gap-1 font-bold">è¤‡è£½</button>
                        <button onclick="showSingleView()" class="flex-1 md:flex-none justify-center px-3 py-1.5 text-sm bg-indigo-50 hover:bg-indigo-100 text-indigo-600 rounded-lg transition font-bold">è¿”å›æŠ½ç±¤</button>
                    </div>
                </div>
                <div id="groupsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4 pb-4 overflow-y-auto max-h-[60vh]"></div>
            </div>

            <!-- è¨ˆåˆ†æ¿è¦–åœ– -->
            <div id="scoreView" class="hidden flex-col w-full flex-1">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 border-b border-gray-100 pb-4 gap-4 md:gap-0">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>åˆ†çµ„è¨ˆåˆ†æ¿
                    </h2>
                    <div class="flex gap-2 w-full md:w-auto">
                        <button onclick="resetScores()" class="flex-1 md:flex-none justify-center px-3 py-1.5 text-sm bg-red-50 hover:bg-red-100 text-red-600 rounded-lg transition flex items-center gap-1 font-bold">åˆ†æ•¸æ­¸é›¶</button>
                        <button onclick="showGroupView()" class="flex-1 md:flex-none justify-center px-3 py-1.5 text-sm bg-indigo-50 hover:bg-indigo-100 text-indigo-600 rounded-lg transition font-bold">è¿”å›æ¸…å–®</button>
                    </div>
                </div>
                <div id="scoreContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4 pb-4 overflow-y-auto max-h-[60vh]"></div>
            </div>

            <!-- è½‰ç›¤è¦–åœ– -->
            <div id="wheelView" class="hidden flex-col items-center justify-center w-full flex-1 relative">
                 <div class="w-full flex justify-between items-center mb-4">
                     <h2 class="text-2xl font-bold text-gray-800">å¹¸é‹è½‰ç›¤</h2>
                     <button onclick="showSingleView()" class="px-3 py-1.5 text-sm bg-indigo-50 hover:bg-indigo-100 text-indigo-600 rounded-lg transition font-bold">è¿”å›æŠ½ç±¤</button>
                 </div>
                 <div class="relative w-full max-w-[450px] aspect-square flex items-center justify-center wheel-shadow rounded-full">
                    <canvas id="wheelCanvas" width="500" height="500" class="w-full h-full transform transition-transform duration-[4000ms] ease-out"></canvas>
                    <div class="absolute top-0 left-1/2 -translate-x-1/2 -translate-y-4 w-12 h-14 z-20 pointer-shadow"><svg viewBox="0 0 40 50" fill="none"><path d="M20 50L0 10C0 4.47715 4.47715 0 10 0H30C35.5228 0 40 4.47715 40 10L20 50Z" fill="#EF4444"/><path d="M20 50L0 10C0 4.47715 4.47715 0 10 0H30C35.5228 0 40 4.47715 40 10L20 50Z" stroke="white" stroke-width="2"/><circle cx="20" cy="12" r="6" fill="#7F1D1D"/></svg></div>
                    <button onclick="spinWheel()" id="spinBtn" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-20 h-20 bg-gradient-to-b from-white to-gray-200 rounded-full shadow-[0_4px_10px_rgba(0,0,0,0.3)] border-[6px] border-indigo-500 flex items-center justify-center text-indigo-600 font-black text-xl z-10 hover:scale-105 transition active:scale-95 active:shadow-inner">GO</button>
                 </div>
            </div>
        </div>

        <!-- Footer Control Bar -->
        <div class="bg-gray-50/90 backdrop-blur border-t border-gray-200 p-4 md:p-6">
            <div class="flex flex-col md:flex-row gap-4 justify-between items-center bg-white rounded-2xl p-3 shadow-sm border border-gray-100">
                <div class="flex items-center gap-3 w-full md:w-auto justify-center md:justify-start px-2">
                    <span class="text-sm font-bold text-gray-500 whitespace-nowrap">æŠ½ä¸­å¾Œ:</span>
                    <div class="flex bg-gray-100 p-1 rounded-lg">
                        <button id="btnKeep" onclick="setMode('keep')" class="px-3 py-1.5 text-sm font-bold rounded-md transition-all text-gray-500">ä¿ç•™åå–®</button>
                        <button id="btnRemove" onclick="setMode('remove')" class="px-3 py-1.5 text-sm font-bold rounded-md transition-all bg-white text-indigo-600 shadow-sm">ç§»é™¤åå–®</button>
                    </div>
                    <input type="checkbox" id="removeAfterPick" class="hidden" checked>
                </div>
                <div class="w-px h-8 bg-gray-200 hidden md:block"></div>
                <div class="flex items-center gap-2 w-full md:w-auto justify-center">
                    <span class="text-sm font-bold text-gray-500 whitespace-nowrap">åˆ†çµ„:</span>
                    <div class="flex items-center border border-gray-200 rounded-lg overflow-hidden bg-gray-50">
                        <input type="number" id="groupCount" min="2" value="2" class="w-12 p-1.5 text-center bg-transparent focus:outline-none text-sm font-bold text-gray-700">
                        <span class="text-xs font-bold text-gray-400 border-r border-gray-200 px-1">çµ„</span>
                        <button onclick="generateGroups()" class="bg-white hover:bg-gray-50 text-indigo-600 px-3 py-1.5 text-sm font-bold transition whitespace-nowrap">åŸ·è¡Œ</button>
                    </div>
                </div>
                <div class="w-px h-8 bg-gray-200 hidden md:block"></div>
                <div class="w-full md:w-auto flex justify-center md:justify-end">
                    <button onclick="initWheelMode()" class="flex items-center gap-2 text-sm font-bold text-orange-500 hover:text-orange-600 transition px-2">
                        <div class="p-1.5 bg-orange-100 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg></div>
                        <span>å¹¸é‹è½‰ç›¤</span>
                    </button>
                </div>
            </div>
            <div class="mt-4 text-center w-full"><p class="text-sm text-gray-300 font-medium tracking-widest hover:text-indigo-300 transition-colors cursor-default signature-font">Design by Sophia Wong</p></div>
        </div>
    </div>

    <!-- Modals -->
    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden flex items-center justify-center p-4 transition-opacity duration-300 opacity-0 pointer-events-none backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full flex flex-col max-h-[90vh] transform transition-all scale-90">
            <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-gray-50 rounded-t-2xl"><h3 class="text-xl font-bold text-gray-800">ç·¨è¼¯åå–®</h3><button onclick="closeEditModal()" class="text-gray-400 hover:text-gray-600 transition"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button></div>
            <div class="p-5 flex-1 overflow-hidden flex flex-col">
                <div class="flex justify-between items-center mb-2"><label class="text-sm font-bold text-gray-500 uppercase tracking-wide">åå–®å…§å®¹ (<span id="count">0</span> äºº)</label>
                <div class="flex gap-2"><button onclick="exportList()" class="text-xs bg-indigo-50 text-indigo-600 px-2 py-1 rounded transition">åŒ¯å‡º</button><label class="text-xs bg-indigo-50 text-indigo-600 hover:bg-indigo-100 px-2 py-1 rounded transition cursor-pointer">åŒ¯å…¥<input type="file" id="fileInput" accept=".json,.txt" class="hidden" onchange="importList(this)"></label></div></div>
                <textarea id="inputNames" class="flex-1 w-full p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none resize-none text-gray-700 bg-gray-50 shadow-inner text-base" placeholder="æ¯è¡Œä¸€å€‹åå­—"></textarea>
            </div>
            <div class="p-5 border-t border-gray-100 bg-gray-50 rounded-b-2xl flex justify-between gap-3"><div class="flex gap-2"><button onclick="addDefaultList()" class="px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm font-medium">è¼‰å…¥ç¯„ä¾‹</button><button onclick="clearList()" class="px-3 py-2 bg-white border border-red-200 text-red-600 rounded-lg text-sm font-medium">æ¸…ç©º</button></div><button onclick="closeEditModal()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg text-sm font-bold">å®Œæˆ</button></div>
        </div>
    </div>
    <div id="customModal" class="fixed inset-0 bg-black bg-opacity-50 z-[60] hidden flex items-center justify-center p-4 transition-opacity duration-300 opacity-0 pointer-events-none" style="backdrop-filter: blur(2px);"><div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 transform transition-all scale-90 text-center"><div id="modalMessage" class="text-gray-600 mb-6 text-sm leading-relaxed"></div><div id="modalActions" class="flex justify-center gap-3"></div></div></div>

    <script>
        let names = [];
        let isRolling = false;
        let rollInterval;
        let history = []; 
        let soundEnabled = true;
        let wakeLock = null;
        let audioCtx = null; 
        let currentGroups = [];
        let groupScores = [];
        let pickedFromGroups = new Set(); 
        let wheelCanvas, wheelCtx;
        let currentRotation = 0;
        let isSpinningWheel = false;
        let lastTickAngle = 0; 
        let wheelColors = ['#FF9AA2', '#FFB7B2', '#FFDAC1', '#E2F0CB', '#B5EAD7', '#C7CEEA', '#90dbf4', '#f1c0e8'];
        const cuteEmojis = ["ğŸ¶","ğŸ±","ğŸ­","ğŸ¹","ğŸ°","ğŸ¦Š","ğŸ»","ğŸ¼","ğŸ¨","ğŸ¯","ğŸ¦","ğŸ®","ğŸ·","ğŸ¸","ğŸµ","ğŸ”","ğŸ§","ğŸ¦","ğŸ¦†","ğŸ¦„","ğŸ¦‹","ğŸ¢","ğŸ¬","ğŸ³","ğŸ¦–","ğŸ¦•","ğŸ˜","ğŸ¦’","ğŸ","ğŸŠ","ğŸ‹","ğŸŒ","ğŸ‰","ğŸ‡","ğŸ“","ğŸ’","ğŸ‘","ğŸ","ğŸ¥¥","ğŸ¥","ğŸ¥‘","ğŸ¥•","ğŸ„"];

        let timerInterval = null;
        let timerTotalSeconds = 60;
        let timerSecondsRemaining = 60;
        let isTimerRunning = false;

        function getRandomEmoji() { return cuteEmojis[Math.floor(Math.random() * cuteEmojis.length)]; }

        const textarea = document.getElementById('inputNames');
        const countDisplay = document.getElementById('count');
        const soundRoll = document.getElementById('sound-roll'); 
        const soundWin = document.getElementById('sound-win');
        const soundAlarm = document.getElementById('sound-alarm');
        const soundBtn = document.getElementById('soundBtn');
        const wakeLockBtn = document.getElementById('wakeLockBtn');
        const modal = document.getElementById('customModal');
        const modalMessage = document.getElementById('modalMessage');
        const modalActions = document.getElementById('modalActions');
        const editModal = document.getElementById('editModal');
        const singleView = document.getElementById('singleView');
        const groupView = document.getElementById('groupView');
        const wheelView = document.getElementById('wheelView');
        const scoreView = document.getElementById('scoreView');
        const timerView = document.getElementById('timerView');
        const displayName = document.getElementById('displayName');
        const statusText = document.getElementById('statusText');
        const actionBtn = document.getElementById('actionBtn');
        const btnText = document.getElementById('btnText');
        const removeCheckbox = document.getElementById('removeAfterPick');
        const historyList = document.getElementById('historyList');
        const historyCount = document.getElementById('historyCount');
        const resultCard = document.getElementById('resultCard');
        const groupsContainer = document.getElementById('groupsContainer');
        const scoreContainer = document.getElementById('scoreContainer');
        const groupCountInput = document.getElementById('groupCount');
        const wheelCanvasEl = document.getElementById('wheelCanvas');
        const spinBtn = document.getElementById('spinBtn');
        const timerDisplay = document.getElementById('timerDisplay');
        const timerProgress = document.getElementById('timerProgress');
        const timerToggleBtn = document.getElementById('timerToggleBtn');
        const timerToScoreBtn = document.getElementById('timerToScoreBtn');

        window.onload = () => {
            const saved = localStorage.getItem('namesList');
            if (saved) { textarea.value = saved; } else { addDefaultList(); }
            updateCount();
            soundRoll.volume = 0.5; soundWin.volume = 0.5; soundAlarm.volume = 0.6;
            wheelCtx = wheelCanvasEl.getContext('2d');
            updateTimerDisplay();
        };

        function setMode(mode) {
            const checkbox = document.getElementById('removeAfterPick');
            const btnKeep = document.getElementById('btnKeep');
            const btnRemove = document.getElementById('btnRemove');
            checkbox.checked = (mode === 'remove');
            if (checkbox.checked) {
                btnRemove.classList.add('bg-white', 'text-indigo-600', 'shadow-sm'); btnRemove.classList.remove('text-gray-500');
                btnKeep.classList.remove('bg-white', 'text-indigo-600', 'shadow-sm'); btnKeep.classList.add('text-gray-500');
            } else {
                btnKeep.classList.add('bg-white', 'text-indigo-600', 'shadow-sm'); btnKeep.classList.remove('text-gray-500');
                btnRemove.classList.remove('bg-white', 'text-indigo-600', 'shadow-sm'); btnRemove.classList.add('text-gray-500');
            }
        }

        function openEditModal() { editModal.classList.remove('hidden', 'pointer-events-none', 'opacity-0'); editModal.querySelector('div').classList.add('scale-100'); }
        function closeEditModal() { editModal.classList.add('opacity-0', 'pointer-events-none'); editModal.querySelector('div').classList.remove('scale-100'); setTimeout(() => { editModal.classList.add('hidden'); updateCount(); }, 300); }

        function initAudioContext() { if (!audioCtx) { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } if (audioCtx.state === 'suspended') { audioCtx.resume(); } }
        function playWheelTick() { if (!soundEnabled || !audioCtx) return; const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = 'triangle'; osc.frequency.setValueAtTime(200, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(50, audioCtx.currentTime + 0.05); gain.gain.setValueAtTime(0.3, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.05); osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 0.05); }
        function playScoreSound(pos) { if (!soundEnabled || !audioCtx) return; initAudioContext(); const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = pos ? 'sine' : 'square'; osc.frequency.setValueAtTime(pos ? 600 : 200, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(pos ? 1200 : 100, audioCtx.currentTime + 0.1); gain.gain.setValueAtTime(0.1, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1); osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 0.1); }

        function showModal(msg, type = 'alert', onConf = null) {
            modalMessage.innerHTML = msg; modalActions.innerHTML = ''; modal.classList.remove('hidden', 'pointer-events-none', 'opacity-0'); modal.querySelector('div').classList.add('scale-100');
            if (type === 'confirm') {
                const cB = document.createElement('button'); cB.className = "px-4 py-2 text-gray-600 font-bold hover:bg-gray-100 rounded-lg transition text-sm"; cB.innerText = "å–æ¶ˆ"; cB.onclick = closeModal;
                const oB = document.createElement('button'); oB.className = "px-4 py-2 bg-indigo-600 text-white font-bold hover:bg-indigo-700 rounded-lg transition text-sm shadow-md shadow-indigo-200"; oB.innerText = "ç¢ºå®š"; oB.onclick = () => { closeModal(); if (onConf) onConf(); };
                modalActions.appendChild(cB); modalActions.appendChild(oB);
            } else {
                const oB = document.createElement('button'); oB.className = "px-4 py-2 bg-indigo-600 text-white font-bold hover:bg-indigo-700 rounded-lg transition text-sm shadow-md shadow-indigo-200"; oB.innerText = "ç¢ºå®š"; oB.onclick = closeModal;
                modalActions.appendChild(oB);
            }
        }
        function closeModal() { modal.classList.add('opacity-0', 'pointer-events-none'); modal.querySelector('div').classList.remove('scale-100'); setTimeout(() => { modal.classList.add('hidden'); }, 300); }

        document.addEventListener('keydown', (e) => { if (document.activeElement === textarea || document.activeElement === groupCountInput || !modal.classList.contains('hidden') || !editModal.classList.contains('hidden')) return; if (e.code === 'Space') { e.preventDefault(); if (!singleView.classList.contains('hidden')) toggleRoll(); else if (!timerView.classList.contains('hidden')) toggleTimer(); } });
        textarea.addEventListener('input', () => { updateCount(); saveToStorage(); });
        function updateCount() { const t = textarea.value.trim(); names = t ? t.split('\n').map(n => n.trim()).filter(n => n !== '') : []; countDisplay.innerText = names.length; }
        function saveToStorage() { localStorage.setItem('namesList', textarea.value); }
        function addDefaultList() { textarea.value = "åŠ‰èŠ¯å¨œ\næ¥Šæ–æ‰‰\nå³ç¿åœ»\né™³èŠ‹éœ\nä½™è‹±\næ›¾å­æƒ…\næ—å­æ¡“\nè¨±å®¶ç¬ \né«˜å®‰å–†\né»ƒæŸéŠ“\né£›é£›\né™³æŸè¨€\næç§‰èŠ¸"; updateCount(); saveToStorage(); }
        function clearList() { showModal('ç¢ºå®šè¦æ¸…ç©ºåå–®å—ï¼Ÿ', 'confirm', () => { textarea.value = ''; updateCount(); saveToStorage(); resetUI(); clearHistory(); }); }
        function resetList() { textarea.value = localStorage.getItem('namesList') || ""; updateCount(); showModal("å·²é‡ç½®åå–®ã€‚"); }
        function resetScores() { if (!currentGroups.length) return; showModal('ç¢ºå®šè¦å°‡åˆ†æ•¸æ­¸é›¶å—ï¼Ÿ', 'confirm', () => { groupScores = groupScores.map(() => 0); renderScoreboard(); showModal("åˆ†æ•¸å·²é‡ç½®ï¼"); }); }
        function exportList() { updateCount(); if (!names.length) return showModal("åå–®æ˜¯ç©ºçš„ï¼"); const s = JSON.stringify(names); const l = document.createElement('a'); l.setAttribute('href', 'data:application/json;charset=utf-8,'+ encodeURIComponent(s)); l.setAttribute('download', 'namelist.json'); l.click(); }
        function importList(i) { const f = i.files[0]; if (!f) return; const r = new FileReader(); r.onload = (e) => { try { const c = e.target.result; try { const p = JSON.parse(c); textarea.value = Array.isArray(p) ? p.join('\n') : c; } catch { textarea.value = c; } updateCount(); saveToStorage(); showModal("åŒ¯å…¥æˆåŠŸï¼"); } catch { showModal("åŒ¯å…¥å¤±æ•—ï¼"); } i.value = ''; }; r.readAsText(f); }

        function resetUI() { displayName.innerText = "READY?"; displayName.className = "name-display text-5xl md:text-7xl font-black text-gray-300 select-none break-all"; statusText.innerText = "ç­‰å¾…é–‹å§‹"; showSingleView(); }

        function toggleSound() { soundEnabled = !soundEnabled; if (soundEnabled) { soundBtn.classList.replace('text-gray-400', 'text-indigo-600'); soundBtn.classList.replace('bg-gray-100', 'bg-indigo-50'); initAudioContext(); } else { soundBtn.classList.replace('text-indigo-600', 'text-gray-400'); soundBtn.classList.replace('bg-indigo-50', 'bg-gray-100'); soundRoll.pause(); } }
        function playSound(t) { if (!soundEnabled) return; if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume(); if (t === 'roll') { soundRoll.currentTime = 0; soundRoll.play().catch(() => {}); } else if (t === 'win') { soundRoll.pause(); soundWin.currentTime = 0; soundWin.play().catch(() => {}); } else if (t === 'alarm') { soundAlarm.currentTime = 0; soundAlarm.play().catch(() => {}); } }

        async function toggleWakeLock() { if ('wakeLock' in navigator) { try { if (wakeLock === null) { wakeLock = await navigator.wakeLock.request('screen'); wakeLockBtn.classList.replace('bg-gray-100', 'bg-yellow-100'); wakeLockBtn.classList.replace('text-gray-500', 'text-yellow-600'); } else { await wakeLock.release(); wakeLock = null; wakeLockBtn.classList.replace('bg-yellow-100', 'bg-gray-100'); wakeLockBtn.classList.replace('text-yellow-600', 'text-gray-500'); } } catch { showModal("æ¬Šé™è¢«æ‹’ï¼"); wakeLock = null; } } else { showModal("ç€è¦½å™¨ä¸æ”¯æ´ï¼"); } }

        function toggleRoll() { updateCount(); initAudioContext(); if (!names.length) return openEditModal(); if (isRolling) stopRoll(); else startRoll(); }
        function startRoll() { isRolling = true; showSingleView(); btnText.innerText = "åœæ­¢ (Space)"; actionBtn.classList.replace('from-indigo-600', 'from-pink-500'); actionBtn.classList.replace('to-purple-600', 'to-rose-500'); statusText.innerText = "æ­£åœ¨æŠ½é¸ä¸­..."; resultCard.classList.add('border-indigo-400'); displayName.classList.remove('text-gray-300'); displayName.classList.add('text-indigo-600'); playSound('roll'); rollInterval = setInterval(() => { displayName.innerText = getRandomEmoji() + ' ' + names[Math.floor(Math.random() * names.length)]; }, 50); }
        function stopRoll() { clearInterval(rollInterval); isRolling = false; const idx = Math.floor(Math.random() * names.length); const winName = names[idx]; const winE = getRandomEmoji(); displayName.innerText = `${winE} ${winName}`; statusText.innerText = "æ­å–œä¸­çï¼"; btnText.innerText = "é–‹å§‹é»å"; actionBtn.classList.replace('from-pink-500', 'from-indigo-600'); actionBtn.classList.replace('to-rose-500', 'to-purple-600'); displayName.classList.add('animate-pop', 'text-red-600'); resultCard.classList.remove('border-indigo-400'); playSound('win'); addToHistory(`${winE} ${winName}`); fireConfetti(); if (removeCheckbox.checked) setTimeout(() => removeName(idx), 1500); }
        function removeName(i) { const r = names.splice(i, 1); textarea.value = names.join('\n'); updateCount(); saveToStorage(); statusText.innerText = `å·²ç§»é™¤: ${r[0]}`; }
        function addToHistory(n) { history.push(n); renderHistory(); }
        function clearHistory() { history = []; renderHistory(); }
        function renderHistory() { historyCount.innerText = history.length; historyList.innerHTML = history.length ? [...history].reverse().map(n => `<span class="px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800 animate-pop">${n}</span>`).join('') : '<span class="text-xs text-gray-400 italic">å°šæœªé–‹å§‹</span>'; }

        function generateGroups() { 
            updateCount(); initAudioContext(); 
            if (!names.length) return openEditModal(); 
            const n = parseInt(groupCountInput.value); 
            if (isNaN(n) || n < 2 || n > names.length) return showModal("çµ„æ•¸è¨­å®šéŒ¯èª¤ï¼"); 
            let s = [...names].sort(() => Math.random() - 0.5); 
            currentGroups = Array.from({ length: n }, () => []); 
            groupScores = new Array(n).fill(0); 
            pickedFromGroups.clear(); 
            s.forEach((v, i) => { currentGroups[i % n].push(`${getRandomEmoji()} ${v}`); }); 
            renderGroups(); showGroupView(); fireConfetti(); playSound('win'); 
        }

        function renderGroups() {
            groupsContainer.innerHTML = currentGroups.map((g, i) => {
                const membersHtml = g.map(n => {
                    const isPicked = pickedFromGroups.has(n);
                    return `<li class="flex items-center gap-2 p-1 transition-all ${isPicked ? 'picked-member' : ''}"><span class="w-1.5 h-1.5 bg-gray-300 rounded-full"></span>${n}</li>`;
                }).join('');
                
                return `
                <div class="group-card bg-white rounded-xl border border-gray-200 shadow-sm p-4" style="animation-delay: ${i*0.1}s">
                    <h3 class="text-lg font-bold text-rose-600 mb-3 border-b pb-2 flex justify-between items-center">
                        <div class="flex items-center gap-2"><span>ç¬¬ ${i+1} çµ„</span><span class="text-xs bg-rose-50 px-2 py-0.5 rounded-full text-rose-400">${g.length}äºº</span></div>
                        <button onclick="pickFromGroup(${i})" class="p-1.5 rounded-lg bg-rose-50 text-rose-500 hover:bg-rose-100 transition"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg></button>
                    </h3>
                    <ul class="text-gray-700 space-y-1 text-sm">${membersHtml}</ul>
                </div>`;
            }).join('');
        }

        function renderScoreboard() {
            scoreContainer.innerHTML = currentGroups.map((g, i) => {
                const membersFormatted = g.map(n => {
                    const isPicked = pickedFromGroups.has(n);
                    return isPicked ? `<span class="picked-member">${n}</span>` : `<span>${n}</span>`;
                }).join('ã€');

                return `
                <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-4 flex flex-col items-center relative">
                    <button onclick="pickFromGroup(${i})" class="absolute top-2 right-2 p-2 rounded-lg text-rose-400 hover:bg-rose-50 transition"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg></button>
                    <h3 class="text-lg font-bold text-rose-600 border-b w-full text-center pb-2 mb-2">ç¬¬ ${i+1} çµ„</h3>
                    <div class="text-6xl font-black text-indigo-600 my-4" id="score-display-${i}">${groupScores[i]}</div>
                    <div class="flex gap-4"><button onclick="updateScore(${i},-1)" class="w-12 h-12 rounded-full bg-red-100 text-red-600 font-bold hover:bg-red-200 transition">-1</button><button onclick="updateScore(${i},1)" class="w-12 h-12 rounded-full bg-green-100 text-green-600 font-bold hover:bg-green-200 transition">+1</button></div>
                    <div class="mt-4 text-sm font-bold text-gray-700 text-center w-full bg-rose-50/50 p-2 rounded-lg leading-relaxed shadow-inner">${membersFormatted}</div>
                </div>`;
            }).join('');
        }

        function pickFromGroup(groupIndex) {
            initAudioContext();
            const group = currentGroups[groupIndex];
            if (!group || group.length === 0) return;
            const candidates = group.filter(m => !pickedFromGroups.has(m));
            if (candidates.length === 0) {
                showModal(`<div class="text-xl font-bold text-gray-600">ç¬¬ ${groupIndex + 1} çµ„æˆå“¡å·²å…¨æ•¸æŠ½éå›‰ï¼</div>`);
                return;
            }
            showModal(`<div class="flex flex-col items-center"><div class="text-lg text-gray-500 mb-4">æ­£åœ¨å¾ç¬¬ ${groupIndex + 1} çµ„ä¸­æŠ½é¸...</div><div id="pickingDisplay" class="text-3xl font-black text-indigo-600 animate-pulse h-10"></div></div>`);
            const display = document.getElementById('pickingDisplay');
            playSound('roll');
            let count = 0; const maxCycles = 15;
            const interval = setInterval(() => {
                display.innerText = candidates[Math.floor(Math.random() * candidates.length)];
                count++;
                if (count >= maxCycles) {
                    clearInterval(interval); 
                    const winner = candidates[Math.floor(Math.random() * candidates.length)];
                    pickedFromGroups.add(winner); 
                    playSound('win'); fireConfetti();
                    showModal(`<div class="flex flex-col items-center"><div class="text-xl font-bold mb-3 text-gray-700">ç¬¬ ${groupIndex+1} çµ„çš„å¤©é¸ä¹‹äººï¼š</div><div class="text-4xl font-black text-rose-600 animate-pop">ğŸ‰ ${winner} ğŸ‰</div></div>`);
                    if (!groupView.classList.contains('hidden')) renderGroups();
                    if (!scoreView.classList.contains('hidden')) renderScoreboard();
                }
            }, 100);
        }

        function updateScore(idx, d) { groupScores[idx] += d; const el = document.getElementById(`score-display-${idx}`); if (el) { el.innerText = groupScores[idx]; el.classList.remove('score-pop'); void el.offsetWidth; el.classList.add('score-pop'); } playScoreSound(d > 0); }

        function showTimerView() { hideAll(); timerView.classList.remove('hidden'); timerView.classList.add('flex'); if (currentGroups.length > 0) timerToScoreBtn.classList.remove('hidden'); else timerToScoreBtn.classList.add('hidden'); }
        function setTimer(s) { resetTimer(); timerTotalSeconds = s; timerSecondsRemaining = s; updateTimerDisplay(); }
        function updateTimerDisplay() { const m = Math.floor(timerSecondsRemaining / 60); const s = timerSecondsRemaining % 60; timerDisplay.innerText = `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`; const o = 282.7 - (timerSecondsRemaining / timerTotalSeconds) * 282.7; timerProgress.style.strokeDashoffset = o; if (timerSecondsRemaining <= 10 && isTimerRunning) timerDisplay.classList.add('timer-danger'); else timerDisplay.classList.remove('timer-danger'); }
        function toggleTimer() { initAudioContext(); if (isTimerRunning) pauseTimer(); else startTimer(); }
        function startTimer() { if (timerSecondsRemaining <= 0) return; isTimerRunning = true; timerToggleBtn.innerText = "æš«åœ"; timerToggleBtn.classList.replace('bg-indigo-600', 'bg-rose-600'); timerInterval = setInterval(() => { timerSecondsRemaining--; updateTimerDisplay(); if (timerSecondsRemaining <= 0) { clearInterval(timerInterval); timerFinished(); } }, 1000); }
        function pauseTimer() { isTimerRunning = false; clearInterval(timerInterval); timerToggleBtn.innerText = "ç¹¼çºŒ"; timerToggleBtn.classList.replace('bg-rose-600', 'bg-indigo-600'); }
        function resetTimer() { isTimerRunning = false; clearInterval(timerInterval); timerSecondsRemaining = timerTotalSeconds; timerToggleBtn.innerText = "é–‹å§‹"; timerToggleBtn.className = "px-8 py-3 bg-indigo-600 text-white rounded-xl font-bold shadow-lg shadow-indigo-200 hover:scale-105 active:scale-95 transition"; updateTimerDisplay(); }
        function timerFinished() { isTimerRunning = false; playSound('alarm'); fireConfetti(); showModal(`<div class="text-2xl font-black text-rose-600">âŒ› æ™‚é–“åˆ°ï¼</div>`); resetTimer(); }

        function initWheelMode() { updateCount(); initAudioContext(); if (names.length < 2) return showModal("è‡³å°‘éœ€ 2 äººï¼"); showWheelView(); currentRotation = 0; lastTickAngle = 0; drawWheel(); }
        function drawWheel() { if (!wheelCtx) return; const n = names.length; const arcSize = (2 * Math.PI) / n; wheelCtx.clearRect(0, 0, 500, 500); wheelCtx.save(); wheelCtx.translate(250, 250); wheelCtx.rotate(currentRotation); wheelCtx.translate(-250, -250); for (let i = 0; i < n; i++) { const angle = i * arcSize; wheelCtx.beginPath(); wheelCtx.moveTo(250, 250); wheelCtx.arc(250, 250, 220, angle, angle + arcSize); wheelCtx.fillStyle = wheelColors[i % wheelColors.length]; wheelCtx.fill(); wheelCtx.strokeStyle = "white"; wheelCtx.stroke(); wheelCtx.save(); wheelCtx.translate(250, 250); wheelCtx.rotate(angle + arcSize / 2); wheelCtx.textAlign = "right"; wheelCtx.fillStyle = "#333"; const t = `${cuteEmojis[i % cuteEmojis.length]} ${names[i]}`; let f = 24; wheelCtx.font = `bold ${f}px Noto Sans TC`; while (wheelCtx.measureText(t).width > 154 && f > 10) { f--; wheelCtx.font = `bold ${f}px Noto Sans TC`; } wheelCtx.fillText(t, 200, 5); wheelCtx.restore(); } wheelCtx.beginPath(); wheelCtx.arc(250, 250, 220, 0, 2 * Math.PI); wheelCtx.lineWidth = 16; wheelCtx.strokeStyle = "white"; wheelCtx.stroke(); wheelCtx.restore(); }
        function spinWheel() { if (isSpinningWheel) return; initAudioContext(); isSpinningWheel = true; spinBtn.disabled = true; const s = (5 * 2 * Math.PI) + (Math.random() * 2 * Math.PI); const dur = 5000; const st = currentRotation; const startT = performance.now(); lastTickAngle = st; function animate(t) { const el = t - startT; if (el < dur) { const p = el / dur; const e = 1 - Math.pow(1 - p, 3); const nr = st + (s * e); const aSize = (2 * Math.PI) / names.length; if (nr - lastTickAngle >= aSize) { playWheelTick(); lastTickAngle += aSize; } currentRotation = nr; drawWheel(); requestAnimationFrame(animate); } else { currentRotation = st + s; drawWheel(); isSpinningWheel = false; spinBtn.disabled = false; const n = currentRotation % (2 * Math.PI); const aFinal = (2 * Math.PI) / names.length; let pa = (3 * Math.PI / 2 - n) % (2 * Math.PI); if (pa < 0) pa += 2 * Math.PI; const wi = Math.floor(pa / aFinal); playSound('win'); fireConfetti(); showModal(`<div class="text-xl font-bold mb-3 text-gray-700">æ­å–œï¼æŒ‡é‡æŒ‡å‘äº†ï¼š</div><div class="text-4xl font-black text-rose-600 animate-pop">ğŸ‰ ${cuteEmojis[wi % cuteEmojis.length]} ${names[wi]} ğŸ‰</div>`); addToHistory(`ğŸ¯ ${cuteEmojis[wi % cuteEmojis.length]} ${names[wi]}`); } } requestAnimationFrame(animate); }

        function hideAll() { [singleView, groupView, wheelView, scoreView, timerView].forEach(v => { v.classList.add('hidden'); v.classList.remove('flex'); }); }
        function showSingleView() { hideAll(); singleView.classList.remove('hidden'); singleView.classList.add('flex'); }
        function showGroupView() { hideAll(); groupView.classList.remove('hidden'); groupView.classList.add('flex'); renderGroups(); }
        function showWheelView() { hideAll(); wheelView.classList.remove('hidden'); wheelView.classList.add('flex'); }
        function showScoreView() { if (!currentGroups.length) return showModal("è«‹å…ˆåˆ†çµ„ï¼"); hideAll(); scoreView.classList.remove('hidden'); scoreView.classList.add('flex'); renderScoreboard(); }

        function copyGroups() { let t = currentGroups.map((g, i) => `ç¬¬ ${i+1} çµ„: ${g.join(', ')}`).join('\n'); navigator.clipboard.writeText(t).then(() => showModal("å·²è¤‡è£½ï¼")).catch(() => { const el = document.createElement("textarea"); el.value = t; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el); showModal("å·²è¤‡è£½ï¼"); }); }
        function fireConfetti() { const end = Date.now() + 2000; const inter = setInterval(() => { if (Date.now() > end) return clearInterval(inter); confetti({ particleCount: 40, origin: { x: Math.random(), y: Math.random() - 0.2 } }); }, 200); }
    </script>
</body>
</html>