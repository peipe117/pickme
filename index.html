<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†çµ„é»é»å</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&family=LXGW+WenKai+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .signature-font {
            font-family: 'LXGW WenKai TC', serif;
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        .name-display {
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            transition: all 0.1s;
        }
        .glow-btn {
            transition: all 0.3s ease;
        }
        .glow-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        .glow-btn:active {
            transform: translateY(1px);
        }
        textarea::-webkit-scrollbar { width: 8px; }
        textarea::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        textarea::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        textarea::-webkit-scrollbar-thumb:hover { background: #555; }
        
        .animate-pop { animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        
        .group-card { animation: slideIn 0.4s ease-out forwards; opacity: 0; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        /* éŸ³æ•ˆæŒ‰éˆ•æ¨£å¼ */
        .sound-btn.active svg { fill: currentColor; }
        .sound-btn.muted svg { fill: none; opacity: 0.5; }

        /* Modal å‹•ç•« */
        .modal-enter { opacity: 0; transform: scale(0.9); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: all 0.2s ease-out; }
        .modal-exit { opacity: 1; transform: scale(1); }
        .modal-exit-active { opacity: 0; transform: scale(0.9); transition: all 0.2s ease-in; }

        /* è½‰ç›¤é™°å½±æ•ˆæœ */
        .wheel-shadow { filter: drop-shadow(0 10px 15px rgba(0, 0, 0, 0.3)); }
        .pointer-shadow { filter: drop-shadow(0 4px 6px rgba(0,0,0,0.4)); }
    </style>
</head>
<body class="flex items-center justify-center p-4">

    <!-- éŸ³æ•ˆè³‡æº -->
    <audio id="sound-roll" loop src="https://assets.mixkit.co/active_storage/sfx/2044/2044-preview.mp3"></audio>
    <audio id="sound-win" src="https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3"></audio>

    <!-- Main Container -->
    <div class="glass-panel w-full max-w-4xl rounded-2xl overflow-hidden flex flex-col shadow-2xl h-[90vh] md:h-auto md:min-h-[700px]">
        
        <!-- Header -->
        <div class="flex justify-between items-center p-4 md:px-8 border-b border-gray-100 bg-white/50">
            <h1 class="text-2xl font-black text-indigo-600 flex items-center gap-2 cursor-pointer select-none" onclick="window.location.reload()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
                åˆ†çµ„é»é»å
            </h1>
            
            <div class="flex gap-2">
                <button onclick="openEditModal()" class="p-2 rounded-full bg-indigo-50 hover:bg-indigo-100 text-indigo-600 transition tooltip-container relative group" title="ç·¨è¼¯åå–®">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                    </svg>
                    <span class="absolute right-0 top-full mt-1 w-max px-2 py-1 bg-black text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-50">ç·¨è¼¯åå–®</span>
                </button>

                <button id="wakeLockBtn" onclick="toggleWakeLock()" class="p-2 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-500 transition tooltip-container relative group" title="é˜²æ­¢è¢å¹•ä¼‘çœ ">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                    </svg>
                    <span class="absolute right-0 top-full mt-1 w-max px-2 py-1 bg-black text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-50">è¢å¹•å¸¸äº®</span>
                </button>

                <button id="soundBtn" onclick="toggleSound()" class="sound-btn active p-2 rounded-full bg-indigo-50 hover:bg-indigo-100 text-indigo-600 transition relative group" title="é–‹é—œéŸ³æ•ˆ">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM14.657 2.929a1 1 0 011.414 0A9.972 9.972 0 0119 10a9.972 9.972 0 01-2.929 7.071 1 1 0 01-1.414-1.414A7.971 7.971 0 0017 10c0-2.21-.894-4.208-2.343-5.657a1 1 0 010-1.414zm-2.829 2.828a1 1 0 011.415 0A5.983 5.983 0 0115 10a5.984 5.984 0 01-1.757 4.243 1 1 0 01-1.415-1.415A3.984 3.984 0 0013 10a3.983 3.983 0 00-1.172-2.828 1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                    <span class="absolute right-0 top-full mt-1 w-max px-2 py-1 bg-black text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-50">é–‹é—œéŸ³æ•ˆ</span>
                </button>
            </div>
        </div>

        <!-- Main Display Area -->
        <div class="flex-1 px-4 py-6 md:px-8 flex flex-col bg-white relative overflow-y-auto overflow-x-hidden">
            
            <!-- å–®äººæŠ½ç±¤è¦–åœ– -->
            <div id="singleView" class="flex-1 flex flex-col items-center justify-center w-full transition-opacity duration-300">
                <div id="resultCard" class="relative w-full aspect-video md:aspect-auto md:h-64 flex items-center justify-center bg-gradient-to-br from-indigo-50 to-blue-50 rounded-2xl border-2 border-indigo-100 mb-8 p-4 text-center overflow-hidden">
                    <div id="displayName" class="name-display text-5xl md:text-7xl font-black text-gray-300 select-none break-all">
                        READY?
                    </div>
                    <div id="statusText" class="absolute bottom-2 text-sm text-gray-400 font-medium tracking-widest uppercase">ç­‰å¾…é–‹å§‹</div>
                </div>

                <button id="actionBtn" onclick="toggleRoll()" class="glow-btn w-full max-w-sm py-4 rounded-xl bg-gradient-to-r from-indigo-600 to-purple-600 text-white text-2xl font-bold tracking-wider shadow-lg hover:shadow-indigo-500/50 flex items-center justify-center gap-3">
                    <svg id="playIcon" xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span id="btnText">é–‹å§‹é»å</span>
                </button>

                <!-- æ­·å²ç´€éŒ„ -->
                <div class="mt-8 w-full max-w-lg">
                    <div class="flex justify-between items-end mb-2 border-b border-gray-100 pb-1">
                        <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">æœ¬è¼ªå·²æŠ½å‡º (<span id="historyCount">0</span>)</span>
                        <button onclick="clearHistory()" class="text-xs text-gray-400 hover:text-red-500">æ¸…é™¤ç´€éŒ„</button>
                    </div>
                    <div id="historyList" class="flex flex-wrap gap-2 justify-center min-h-[2rem] max-h-[100px] overflow-y-auto p-2 bg-gray-50 rounded-lg border border-gray-100">
                        <span class="text-xs text-gray-400 italic py-1">å°šæœªé–‹å§‹é»å</span>
                    </div>
                </div>
            </div>

            <!-- åˆ†çµ„çµæœè¦–åœ– -->
            <div id="groupView" class="hidden flex-col w-full flex-1">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 border-b border-gray-100 pb-4 gap-4 md:gap-0">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                        åˆ†çµ„çµæœ
                    </h2>
                    <div class="flex gap-2 w-full md:w-auto">
                        <button onclick="copyGroups()" class="flex-1 md:flex-none justify-center px-3 py-1.5 text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition flex items-center gap-1 font-bold">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
                            </svg>
                            è¤‡è£½
                        </button>
                        <button onclick="showSingleView()" class="flex-1 md:flex-none justify-center px-3 py-1.5 text-sm bg-indigo-50 hover:bg-indigo-100 text-indigo-600 rounded-lg transition font-bold">
                            è¿”å›å–®äººæŠ½ç±¤
                        </button>
                    </div>
                </div>
                
                <div id="groupsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4 pb-4 overflow-y-auto max-h-[60vh]">
                    <!-- åˆ†çµ„çµæœå°‡é¡¯ç¤ºæ–¼æ­¤ -->
                </div>
            </div>

            <!-- è½‰ç›¤è¦–åœ– -->
            <div id="wheelView" class="hidden flex-col items-center justify-center w-full flex-1 relative">
                 <div class="w-full flex justify-between items-center mb-4">
                     <h2 class="text-2xl font-bold text-gray-800">å¹¸é‹è½‰ç›¤</h2>
                     <button onclick="showSingleView()" class="px-3 py-1.5 text-sm bg-indigo-50 hover:bg-indigo-100 text-indigo-600 rounded-lg transition font-bold">è¿”å›å–®äººæŠ½ç±¤</button>
                 </div>
                 
                 <div class="relative w-full max-w-[450px] aspect-square flex items-center justify-center wheel-shadow rounded-full">
                    <canvas id="wheelCanvas" width="500" height="500" class="w-full h-full transform transition-transform duration-[4000ms] ease-out"></canvas>
                    
                    <!-- ç¾åŒ–ç‰ˆæŒ‡é‡ (SVG) -->
                    <div class="absolute top-0 left-1/2 -translate-x-1/2 -translate-y-4 w-12 h-14 z-20 pointer-shadow">
                        <svg viewBox="0 0 40 50" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M20 50L0 10C0 4.47715 4.47715 0 10 0H30C35.5228 0 40 4.47715 40 10L20 50Z" fill="#EF4444"/>
                            <path d="M20 50L0 10C0 4.47715 4.47715 0 10 0H30C35.5228 0 40 4.47715 40 10L20 50Z" stroke="white" stroke-width="2"/>
                            <circle cx="20" cy="12" r="6" fill="#7F1D1D"/>
                        </svg>
                    </div>
                    
                    <!-- ä¸­å¿ƒæŒ‰éˆ• -->
                    <button onclick="spinWheel()" id="spinBtn" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-20 h-20 bg-gradient-to-b from-white to-gray-200 rounded-full shadow-[0_4px_10px_rgba(0,0,0,0.3)] border-[6px] border-indigo-500 flex items-center justify-center text-indigo-600 font-black text-xl z-10 hover:scale-105 transition active:scale-95 active:shadow-inner">
                        GO
                    </button>
                 </div>
            </div>

        </div>

        <!-- Integrated Footer Control Bar -->
        <div class="bg-gray-50/90 backdrop-blur border-t border-gray-200 p-4 md:p-6">
            <div class="flex flex-col md:flex-row gap-4 justify-between items-center bg-white rounded-2xl p-3 shadow-sm border border-gray-100">
                
                <!-- 1. Mode: Keep/Remove Toggle (Updated with Buttons, Default: Remove) -->
                <div class="flex items-center gap-3 w-full md:w-auto justify-center md:justify-start px-2">
                    <span class="text-sm font-bold text-gray-500 whitespace-nowrap">æŠ½ä¸­å¾Œ:</span>
                    <div class="flex bg-gray-100 p-1 rounded-lg">
                        <button id="btnKeep" onclick="setMode('keep')" class="px-3 py-1.5 text-sm font-bold rounded-md transition-all text-gray-500">ä¿ç•™åå–®</button>
                        <button id="btnRemove" onclick="setMode('remove')" class="px-3 py-1.5 text-sm font-bold rounded-md transition-all bg-white text-indigo-600 shadow-sm">ç§»é™¤åå–®</button>
                    </div>
                    <!-- Hidden Checkbox for logic compatibility (Default Checked) -->
                    <input type="checkbox" id="removeAfterPick" class="hidden" checked>
                </div>

                <div class="w-px h-8 bg-gray-200 hidden md:block"></div>

                <!-- 2. Grouping Mode -->
                <div class="flex items-center gap-2 w-full md:w-auto justify-center">
                    <span class="text-sm font-bold text-gray-500 whitespace-nowrap">åˆ†çµ„:</span>
                    <div class="flex items-center border border-gray-200 rounded-lg overflow-hidden bg-gray-50">
                        <input type="number" id="groupCount" min="2" value="2" class="w-12 p-1.5 text-center bg-transparent focus:outline-none text-sm font-bold text-gray-700">
                        <span class="text-xs font-bold text-gray-400 border-r border-gray-200 px-1">çµ„</span>
                        <button onclick="generateGroups()" class="bg-white hover:bg-gray-50 text-indigo-600 px-3 py-1.5 text-sm font-bold transition whitespace-nowrap">åŸ·è¡Œ</button>
                    </div>
                </div>

                <div class="w-px h-8 bg-gray-200 hidden md:block"></div>

                <!-- 3. Wheel Mode -->
                <div class="w-full md:w-auto flex justify-center md:justify-end">
                    <button onclick="initWheelMode()" class="flex items-center gap-2 text-sm font-bold text-orange-500 hover:text-orange-600 transition px-2">
                        <div class="p-1.5 bg-orange-100 rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <span>å¹¸é‹è½‰ç›¤</span>
                    </button>
                </div>

            </div>
            
            <!-- Signature -->
            <div class="mt-4 text-center w-full">
                <p class="text-sm text-gray-300 font-medium tracking-widest hover:text-indigo-300 transition-colors cursor-default signature-font">
                    Design by Sophia
                </p>
            </div>
        </div>
    </div>

    <!-- Edit List Modal -->
    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden flex items-center justify-center p-4 transition-opacity duration-300 opacity-0 pointer-events-none backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full flex flex-col max-h-[90vh] transform transition-all scale-90">
            <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-gray-50 rounded-t-2xl">
                <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                    </svg>
                    ç·¨è¼¯åå–®
                </h3>
                <button onclick="closeEditModal()" class="text-gray-400 hover:text-gray-600 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <div class="p-5 flex-1 overflow-hidden flex flex-col">
                <div class="flex justify-between items-center mb-2">
                    <label class="text-sm font-bold text-gray-500 uppercase tracking-wide">åå–®å…§å®¹ (<span id="count">0</span> äºº)</label>
                    <div class="flex gap-2">
                        <button onclick="exportList()" class="text-xs bg-indigo-50 text-indigo-600 hover:bg-indigo-100 px-2 py-1 rounded transition flex items-center gap-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                            åŒ¯å‡º
                        </button>
                        <label class="text-xs bg-indigo-50 text-indigo-600 hover:bg-indigo-100 px-2 py-1 rounded transition flex items-center gap-1 cursor-pointer">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                            åŒ¯å…¥
                            <input type="file" id="fileInput" accept=".json,.txt" class="hidden" onchange="importList(this)">
                        </label>
                    </div>
                </div>
                <textarea id="inputNames" class="flex-1 w-full p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none resize-none text-gray-700 bg-gray-50 shadow-inner text-base" placeholder="è«‹åœ¨æ­¤è¼¸å…¥åå­—&#10;æ¯è¡Œä¸€å€‹åå­—"></textarea>
            </div>

            <div class="p-5 border-t border-gray-100 bg-gray-50 rounded-b-2xl flex justify-between gap-3">
                <div class="flex gap-2">
                    <button onclick="addDefaultList()" class="px-3 py-2 bg-white border border-gray-300 hover:bg-gray-100 text-gray-700 rounded-lg text-sm font-medium transition shadow-sm">è¼‰å…¥ç¯„ä¾‹</button>
                    <button onclick="clearList()" class="px-3 py-2 bg-white border border-red-200 hover:bg-red-50 text-red-600 rounded-lg text-sm font-medium transition shadow-sm">æ¸…ç©º</button>
                </div>
                <button onclick="closeEditModal()" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-bold transition shadow-lg shadow-indigo-200">å®Œæˆ</button>
            </div>
        </div>
    </div>

    <!-- Alert Modal Structure -->
    <div id="customModal" class="fixed inset-0 bg-black bg-opacity-50 z-[60] hidden flex items-center justify-center p-4 transition-opacity duration-300 opacity-0 pointer-events-none" style="backdrop-filter: blur(2px);">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 transform transition-all scale-90">
            <!-- ç§»é™¤æ¨™é¡Œ h3 -->
            <div id="modalMessage" class="text-gray-600 mb-6 text-sm leading-relaxed text-center">Message goes here</div>
            <div id="modalActions" class="flex justify-center gap-3">
                <!-- Buttons injected here -->
            </div>
        </div>
    </div>

    <script>
        // ç‹€æ…‹è®Šæ•¸
        let names = [];
        let isRolling = false;
        let rollInterval;
        let originalList = []; 
        let history = []; 
        let soundEnabled = true;
        let wakeLock = null;
        let audioCtx = null; 

        // è½‰ç›¤è®Šæ•¸
        let wheelCanvas, wheelCtx;
        let currentRotation = 0;
        let isSpinningWheel = false;
        let lastTickAngle = 0; 
        
        let wheelColors = ['#FF9AA2', '#FFB7B2', '#FFDAC1', '#E2F0CB', '#B5EAD7', '#C7CEEA', '#90dbf4', '#f1c0e8'];

        const cuteEmojis = [
            "ğŸ¶","ğŸ±","ğŸ­","ğŸ¹","ğŸ°","ğŸ¦Š","ğŸ»","ğŸ¼","ğŸ¨","ğŸ¯","ğŸ¦","ğŸ®","ğŸ·","ğŸ¸","ğŸµ",
            "ğŸ”","ğŸ§","ğŸ¦","ğŸ¦†","ğŸ¦„","ğŸ¦‹","ğŸ¢","ğŸ¬","ğŸ³","ğŸ¦–","ğŸ¦•","ğŸ˜","ğŸ¦’",
            "ğŸ","ğŸŠ","ğŸ‹","ğŸŒ","ğŸ‰","ğŸ‡","ğŸ“","ğŸ’","ğŸ‘","ğŸ","ğŸ¥¥","ğŸ¥","ğŸ¥‘","ğŸŒ½","ğŸ¥•","ğŸ„"
        ];

        function getRandomEmoji() {
            return cuteEmojis[Math.floor(Math.random() * cuteEmojis.length)];
        }

        // DOM å…ƒç´ 
        const textarea = document.getElementById('inputNames');
        const countDisplay = document.getElementById('count');
        const soundRoll = document.getElementById('sound-roll'); 
        const soundWin = document.getElementById('sound-win');
        const soundBtn = document.getElementById('soundBtn');
        const wakeLockBtn = document.getElementById('wakeLockBtn');
        const fileInput = document.getElementById('fileInput');
        
        // Modals
        const modal = document.getElementById('customModal');
        const modalMessage = document.getElementById('modalMessage');
        const modalActions = document.getElementById('modalActions');
        const editModal = document.getElementById('editModal');

        // Views
        const singleView = document.getElementById('singleView');
        const groupView = document.getElementById('groupView');
        const wheelView = document.getElementById('wheelView');
        
        // Single View Specifics
        const displayName = document.getElementById('displayName');
        const statusText = document.getElementById('statusText');
        const actionBtn = document.getElementById('actionBtn');
        const btnText = document.getElementById('btnText');
        const removeCheckbox = document.getElementById('removeAfterPick');
        const historyList = document.getElementById('historyList');
        const historyCount = document.getElementById('historyCount');
        const resultCard = document.getElementById('resultCard');

        // Group View Specifics
        const groupsContainer = document.getElementById('groupsContainer');
        const groupCountInput = document.getElementById('groupCount');

        // Wheel View Specifics
        const wheelCanvasEl = document.getElementById('wheelCanvas');
        const spinBtn = document.getElementById('spinBtn');

        // åˆå§‹åŒ–
        window.onload = () => {
            const saved = localStorage.getItem('namesList');
            if (saved) {
                textarea.value = saved;
            } else {
                addDefaultList();
            }
            updateCount();
            
            soundRoll.volume = 0.5;
            soundWin.volume = 0.5;

            // Init Wheel Context
            wheelCtx = wheelCanvasEl.getContext('2d');
        };

        // --- Mode Toggle Logic ---
        function setMode(mode) {
            const checkbox = document.getElementById('removeAfterPick');
            const btnKeep = document.getElementById('btnKeep');
            const btnRemove = document.getElementById('btnRemove');
            
            if (mode === 'remove') {
                checkbox.checked = true;
                btnRemove.classList.add('bg-white', 'text-indigo-600', 'shadow-sm');
                btnRemove.classList.remove('text-gray-500');
                btnKeep.classList.remove('bg-white', 'text-indigo-600', 'shadow-sm');
                btnKeep.classList.add('text-gray-500');
            } else {
                checkbox.checked = false;
                btnKeep.classList.add('bg-white', 'text-indigo-600', 'shadow-sm');
                btnKeep.classList.remove('text-gray-500');
                btnRemove.classList.remove('bg-white', 'text-indigo-600', 'shadow-sm');
                btnRemove.classList.add('text-gray-500');
            }
        }

        // --- Edit Modal Logic ---
        function openEditModal() {
            editModal.classList.remove('hidden', 'pointer-events-none', 'opacity-0');
            editModal.querySelector('div').classList.remove('scale-90');
            editModal.querySelector('div').classList.add('scale-100');
        }

        function closeEditModal() {
            editModal.classList.add('opacity-0', 'pointer-events-none');
            editModal.querySelector('div').classList.remove('scale-100');
            editModal.querySelector('div').classList.add('scale-90');
            setTimeout(() => {
                editModal.classList.add('hidden');
                // Ensure count is updated when closed
                updateCount();
            }, 300);
        }

        // --- Audio System ---
        function initAudioContext() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        function playWheelTick() {
            if (!soundEnabled || !audioCtx) return;
            
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(200, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(50, audioCtx.currentTime + 0.05);
            
            gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.05);
            
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            osc.start();
            osc.stop(audioCtx.currentTime + 0.05);
        }

        // --- Alert Modal System ---
        function showModal(message, type = 'alert', onConfirm = null) {
            // ä½¿ç”¨ innerHTML ä»¥æ”¯æ´å®¢è£½åŒ–æ ¼å¼
            modalMessage.innerHTML = message;
            modalActions.innerHTML = '';
            
            modal.classList.remove('hidden', 'pointer-events-none', 'opacity-0');
            modal.querySelector('div').classList.remove('scale-90');
            modal.querySelector('div').classList.add('scale-100');

            if (type === 'confirm') {
                const cancelBtn = document.createElement('button');
                cancelBtn.className = "px-4 py-2 text-gray-600 font-bold hover:bg-gray-100 rounded-lg transition text-sm";
                cancelBtn.innerText = "å–æ¶ˆ";
                cancelBtn.onclick = closeModal;
                
                const confirmBtn = document.createElement('button');
                confirmBtn.className = "px-4 py-2 bg-indigo-600 text-white font-bold hover:bg-indigo-700 rounded-lg transition text-sm shadow-md shadow-indigo-200";
                confirmBtn.innerText = "ç¢ºå®š";
                confirmBtn.onclick = () => {
                    closeModal();
                    if (onConfirm) onConfirm();
                };
                
                modalActions.appendChild(cancelBtn);
                modalActions.appendChild(confirmBtn);
            } else {
                const okBtn = document.createElement('button');
                okBtn.className = "px-4 py-2 bg-indigo-600 text-white font-bold hover:bg-indigo-700 rounded-lg transition text-sm shadow-md shadow-indigo-200";
                okBtn.innerText = "ç¢ºå®š";
                okBtn.onclick = closeModal;
                modalActions.appendChild(okBtn);
            }
        }

        function closeModal() {
            modal.classList.add('opacity-0', 'pointer-events-none');
            modal.querySelector('div').classList.remove('scale-100');
            modal.querySelector('div').classList.add('scale-90');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        // Input & Keys
        document.addEventListener('keydown', (e) => {
            if (document.activeElement === textarea || document.activeElement === groupCountInput) return;
            if (!modal.classList.contains('hidden')) return; 
            if (!editModal.classList.contains('hidden')) return; 

            if (e.code === 'Space') {
                e.preventDefault(); 
                if (!singleView.classList.contains('hidden') && !singleView.classList.contains('flex-none')) { 
                    toggleRoll();
                }
            }
        });

        textarea.addEventListener('input', () => {
            updateCount();
            saveToStorage();
        });

        function updateCount() {
            const text = textarea.value.trim();
            if (!text) {
                names = [];
            } else {
                names = text.split('\n').map(n => n.trim()).filter(n => n !== '');
            }
            countDisplay.innerText = names.length;
        }

        function saveToStorage() {
            localStorage.setItem('namesList', textarea.value);
        }

        function addDefaultList() {
            const defaults = "åŠ‰èŠ¯å¨œ\næ¥Šæ–æ‰‰\nå³ç¿åœ»\né™³èŠ‹éœ\nä½™è‹±\næ›¾å­æƒ…\næ—å­æ¡“\nè¨±å®¶ç¬ \né«˜å®‰å–†\né»ƒæŸéŠ“\né£›é£›\né™³æŸè¨€\næç§‰èŠ¸";
            textarea.value = defaults;
            updateCount();
            saveToStorage();
            originalList = defaults.split('\n').filter(n => n.trim() !== '');
        }

        function clearList() {
            showModal('ç¢ºå®šè¦æ¸…ç©ºåå–®å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚', 'confirm', () => {
                textarea.value = '';
                updateCount();
                saveToStorage();
                resetUI();
                clearHistory();
            });
        }

        function resetList() {
             textarea.value = localStorage.getItem('namesList') || "";
             updateCount();
             showModal("åå–®å·²é‡ç½®ç‚ºæœ€å¾Œä¿å­˜çš„ç‹€æ…‹ã€‚");
        }

        // --- Import / Export ---
        function exportList() {
            updateCount();
            if (names.length === 0) {
                showModal("åå–®æ˜¯ç©ºçš„ï¼Œç„¡æ³•åŒ¯å‡ºï¼");
                return;
            }
            const dataStr = JSON.stringify(names);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = 'namelist.json';
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        function importList(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    try {
                        const parsed = JSON.parse(content);
                        if (Array.isArray(parsed)) {
                            textarea.value = parsed.join('\n');
                        } else {
                            throw new Error("Invalid JSON array");
                        }
                    } catch (jsonErr) {
                        textarea.value = content;
                    }
                    updateCount();
                    saveToStorage();
                    showModal("åå–®åŒ¯å…¥æˆåŠŸï¼");
                } catch (err) {
                    showModal("åŒ¯å…¥å¤±æ•—ï¼Œæª”æ¡ˆæ ¼å¼éŒ¯èª¤ã€‚");
                }
                input.value = '';
            };
            reader.readAsText(file);
        }

        function resetUI() {
            displayName.innerText = "READY?";
            displayName.className = "name-display text-5xl md:text-7xl font-black text-gray-300 select-none break-all";
            statusText.innerText = "ç­‰å¾…é–‹å§‹";
            showSingleView();
        }

        // --- Sound & WakeLock ---
        function toggleSound() {
            soundEnabled = !soundEnabled;
            if (soundEnabled) {
                soundBtn.classList.remove('muted');
                soundBtn.classList.add('active', 'bg-indigo-50', 'text-indigo-600');
                soundBtn.classList.remove('bg-gray-100', 'text-gray-400');
                initAudioContext(); 
            } else {
                soundBtn.classList.add('muted');
                soundBtn.classList.remove('active', 'bg-indigo-50', 'text-indigo-600');
                soundBtn.classList.add('bg-gray-100', 'text-gray-400');
                soundRoll.pause();
                soundRoll.currentTime = 0;
            }
        }

        function playSound(type) {
            if (!soundEnabled) return;
            if (audioCtx && audioCtx.state === 'suspended') {
                audioCtx.resume();
            }

            if (type === 'roll') {
                soundRoll.currentTime = 0;
                soundRoll.play().catch(e => {});
            } else if (type === 'win') {
                soundRoll.pause();
                soundWin.currentTime = 0;
                soundWin.play().catch(e => {});
            }
        }

        async function toggleWakeLock() {
            if ('wakeLock' in navigator) {
                try {
                    if (wakeLock === null) {
                        wakeLock = await navigator.wakeLock.request('screen');
                        wakeLockBtn.classList.add('bg-yellow-100', 'text-yellow-600');
                        wakeLockBtn.classList.remove('bg-gray-100', 'text-gray-500');
                        wakeLock.addEventListener('release', () => {
                            if(wakeLock === null) {
                                wakeLockBtn.classList.remove('bg-yellow-100', 'text-yellow-600');
                                wakeLockBtn.classList.add('bg-gray-100', 'text-gray-500');
                            }
                        });
                    } else {
                        await wakeLock.release();
                        wakeLock = null;
                        wakeLockBtn.classList.remove('bg-yellow-100', 'text-yellow-600');
                        wakeLockBtn.classList.add('bg-gray-100', 'text-gray-500');
                    }
                } catch (err) {
                    if (err.name === 'NotAllowedError') {
                        showModal("ç„¡æ³•å•Ÿç”¨é˜²ä¼‘çœ ï¼š\næ¬Šé™è¢«æ‹’æˆ–é›»é‡éä½ã€‚");
                    } else {
                        showModal("ç„¡æ³•å•Ÿç”¨é˜²ä¼‘çœ åŠŸèƒ½");
                    }
                    wakeLock = null;
                    wakeLockBtn.classList.remove('bg-yellow-100', 'text-yellow-600');
                    wakeLockBtn.classList.add('bg-gray-100', 'text-gray-500');
                }
            } else {
                showModal("ç€è¦½å™¨ä¸æ”¯æ´é˜²ä¼‘çœ ");
            }
        }

        // --- Single Roll Logic ---
        function toggleRoll() {
            updateCount(); 
            initAudioContext(); 

            if (names.length === 0) {
                showModal("è«‹å…ˆè¼¸å…¥åå–®ï¼");
                openEditModal(); 
                return;
            }

            if (isRolling) {
                stopRoll();
            } else {
                startRoll();
            }
        }

        function startRoll() {
            isRolling = true;
            showSingleView(); 

            btnText.innerText = "åœæ­¢ (Space)";
            actionBtn.classList.remove('from-indigo-600', 'to-purple-600');
            actionBtn.classList.add('from-pink-500', 'to-rose-500');
            statusText.innerText = "æ­£åœ¨æŠ½é¸ä¸­...";
            resultCard.classList.remove('border-indigo-100');
            resultCard.classList.add('border-indigo-400', 'shadow-inner');
            
            displayName.classList.remove('text-gray-300');
            displayName.classList.add('text-indigo-600');
            displayName.classList.remove('animate-pop', 'text-red-600');
            
            playSound('roll');

            let speed = 50;
            rollInterval = setInterval(() => {
                const randomName = names[Math.floor(Math.random() * names.length)];
                displayName.innerText = getRandomEmoji() + ' ' + randomName;
            }, speed);
        }

        function stopRoll() {
            clearInterval(rollInterval);
            isRolling = false;

            const winnerIndex = Math.floor(Math.random() * names.length);
            const winnerName = names[winnerIndex];
            
            const winnerEmoji = getRandomEmoji();
            const finalText = `${winnerEmoji} ${winnerName}`;
            
            displayName.innerText = finalText;

            statusText.innerText = "æ­å–œä¸­çï¼";
            btnText.innerText = "é–‹å§‹é»å";
            actionBtn.classList.add('from-indigo-600', 'to-purple-600');
            actionBtn.classList.remove('from-pink-500', 'to-rose-500');
            
            displayName.classList.add('animate-pop', 'text-red-600');
            resultCard.classList.add('border-indigo-100');
            resultCard.classList.remove('border-indigo-400', 'shadow-inner');

            playSound('win');
            addToHistory(finalText); 
            fireConfetti();

            if (removeCheckbox.checked) {
                setTimeout(() => {
                    removeName(winnerIndex);
                }, 1500);
            }
        }

        // --- Common Utils ---
        function removeName(index) {
            const removed = names.splice(index, 1);
            textarea.value = names.join('\n');
            updateCount();
            saveToStorage();
            statusText.innerText = `å·²ç§»é™¤: ${removed[0]} (å‰©é¤˜ ${names.length} äºº)`;
        }

        function addToHistory(name) {
            history.push(name);
            renderHistory();
        }

        function clearHistory() {
            history = [];
            renderHistory();
        }

        function renderHistory() {
            historyCount.innerText = history.length;
            if (history.length === 0) {
                historyList.innerHTML = '<span class="text-xs text-gray-400 italic py-1">å°šæœªé–‹å§‹é»å</span>';
                return;
            }
            historyList.innerHTML = '';
            [...history].reverse().forEach(name => {
                const tag = document.createElement('span');
                tag.className = "inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800 animate-pop";
                tag.innerText = name;
                historyList.appendChild(tag);
            });
        }

        // --- Group Logic ---
        function generateGroups() {
            updateCount();
            if (names.length === 0) {
                showModal("è«‹å…ˆè¼¸å…¥åå–®ï¼");
                openEditModal();
                return;
            }

            const numGroups = parseInt(groupCountInput.value);
            if (isNaN(numGroups) || numGroups < 2) {
                showModal("è«‹è‡³å°‘åˆ†æˆ 2 çµ„ï¼");
                return;
            }
            
            if (numGroups > names.length) {
                showModal("çµ„æ•¸ä¸èƒ½å¤šæ–¼äººæ•¸ï¼");
                return;
            }

            let shuffled = [...names];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }

            let groups = Array.from({ length: numGroups }, () => []);
            shuffled.forEach((name, index) => {
                groups[index % numGroups].push(`${getRandomEmoji()} ${name}`);
            });

            renderGroups(groups);
            showGroupView();
            fireConfetti();
        }

        function renderGroups(groups) {
            groupsContainer.innerHTML = '';
            groups.forEach((group, index) => {
                const card = document.createElement('div');
                card.className = 'group-card bg-white rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition p-4 flex flex-col';
                card.style.animationDelay = `${index * 0.1}s`;
                
                const title = document.createElement('h3');
                title.className = 'text-lg font-bold text-indigo-600 mb-3 border-b border-gray-100 pb-2 flex justify-between';
                title.innerHTML = `<span>ç¬¬ ${index + 1} çµ„</span> <span class="text-xs bg-indigo-50 text-indigo-400 px-2 py-1 rounded-full">${group.length}äºº</span>`;
                
                const list = document.createElement('ul');
                list.className = 'text-gray-700 space-y-1 text-sm flex-1 font-medium';
                group.forEach(name => {
                    const li = document.createElement('li');
                    li.className = 'flex items-center gap-2';
                    li.innerHTML = `<span class="w-1.5 h-1.5 bg-gray-300 rounded-full"></span>${name}`;
                    list.appendChild(li);
                });

                card.appendChild(title);
                card.appendChild(list);
                groupsContainer.appendChild(card);
            });
        }

        // --- Wheel Logic ---
        function initWheelMode() {
            updateCount();
            if (names.length === 0) {
                showModal("è«‹å…ˆè¼¸å…¥åå–®ï¼");
                openEditModal();
                return;
            }
            if (names.length < 2) {
                showModal("è½‰ç›¤æ¨¡å¼è‡³å°‘éœ€è¦ 2 äººï¼");
                return;
            }
            initAudioContext();
            showWheelView();
            currentRotation = 0; 
            lastTickAngle = 0;
            drawWheel();
        }

        function drawWheel() {
            if (!wheelCtx) return;
            
            const numSegments = names.length;
            const arcSize = (2 * Math.PI) / numSegments;
            const centerX = 250;
            const centerY = 250;
            const radius = 220; 

            wheelCtx.clearRect(0, 0, 500, 500);

            // 1. Rotation
            wheelCtx.save();
            wheelCtx.translate(centerX, centerY);
            wheelCtx.rotate(currentRotation);
            wheelCtx.translate(-centerX, -centerY);

            // 2. Segments
            for (let i = 0; i < numSegments; i++) {
                const angle = i * arcSize;
                const color = wheelColors[i % wheelColors.length];
                
                wheelCtx.beginPath();
                wheelCtx.moveTo(centerX, centerY);
                wheelCtx.arc(centerX, centerY, radius, angle, angle + arcSize);
                wheelCtx.closePath();
                wheelCtx.fillStyle = color;
                wheelCtx.fill();
                wheelCtx.lineWidth = 1;
                wheelCtx.strokeStyle = "white";
                wheelCtx.stroke();

                // Text
                wheelCtx.save();
                wheelCtx.translate(centerX, centerY);
                wheelCtx.rotate(angle + arcSize / 2);
                wheelCtx.textAlign = "right";
                wheelCtx.textBaseline = "middle";
                wheelCtx.fillStyle = "#333";
                
                const emoji = cuteEmojis[i % cuteEmojis.length];
                const text = `${emoji} ${names[i]}`;
                
                let fontSize = 24;
                const maxTextWidth = radius * 0.75; 
                wheelCtx.font = `bold ${fontSize}px 'Noto Sans TC'`;
                let textWidth = wheelCtx.measureText(text).width;
                
                while (textWidth > maxTextWidth && fontSize > 10) {
                    fontSize -= 1;
                    wheelCtx.font = `bold ${fontSize}px 'Noto Sans TC'`;
                    textWidth = wheelCtx.measureText(text).width;
                }

                wheelCtx.shadowColor = "rgba(255, 255, 255, 0.8)";
                wheelCtx.shadowBlur = 4;
                wheelCtx.fillText(text, radius - 20, 0);
                wheelCtx.restore();
            }
            
            // 3. Outer Ring
            wheelCtx.beginPath();
            wheelCtx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
            wheelCtx.lineWidth = 16;
            wheelCtx.strokeStyle = "#FFFFFF"; 
            wheelCtx.stroke();
            
            wheelCtx.beginPath();
            wheelCtx.arc(centerX, centerY, radius + 8, 0, 2 * Math.PI);
            wheelCtx.lineWidth = 2;
            wheelCtx.strokeStyle = "rgba(0,0,0,0.1)";
            wheelCtx.stroke();

            // 4. Lights
            const dotCount = 24; 
            const dotRadius = radius; 
            for (let j = 0; j < dotCount; j++) {
                const dotAngle = (j / dotCount) * 2 * Math.PI;
                const dx = centerX + Math.cos(dotAngle) * dotRadius;
                const dy = centerY + Math.sin(dotAngle) * dotRadius;
                
                wheelCtx.beginPath();
                wheelCtx.arc(dx, dy, 4, 0, 2 * Math.PI);
                wheelCtx.fillStyle = j % 2 === 0 ? "#FFD700" : "#FF6B6B";
                wheelCtx.fill();
            }

            wheelCtx.restore();
        }

        function spinWheel() {
            if (isSpinningWheel) return;
            
            initAudioContext(); 
            isSpinningWheel = true;
            spinBtn.disabled = true;
            
            const spinAngle = (5 * 2 * Math.PI) + (Math.random() * 2 * Math.PI);
            const duration = 5000; 
            const startAngle = currentRotation;
            const startTime = performance.now();
            
            lastTickAngle = startAngle;

            function animate(currentTime) {
                const elapsed = currentTime - startTime;
                if (elapsed < duration) {
                    const progress = elapsed / duration;
                    const easeOut = 1 - Math.pow(1 - progress, 3);
                    
                    const newRotation = startAngle + (spinAngle * easeOut);
                    
                    const delta = newRotation - lastTickAngle;
                    const arcSize = (2 * Math.PI) / names.length;
                    
                    if (delta >= arcSize) {
                        playWheelTick();
                        lastTickAngle = newRotation - (delta % arcSize); 
                    } else if (newRotation - lastTickAngle > arcSize) {
                         playWheelTick();
                         lastTickAngle += arcSize;
                    }

                    currentRotation = newRotation;
                    drawWheel();
                    requestAnimationFrame(animate);
                } else {
                    currentRotation = startAngle + spinAngle;
                    drawWheel();
                    isSpinningWheel = false;
                    spinBtn.disabled = false;
                    
                    const normalizedRotation = currentRotation % (2 * Math.PI);
                    const numSegments = names.length;
                    const arcSize = (2 * Math.PI) / numSegments;
                    
                    let pointerAngle = (3 * Math.PI / 2 - normalizedRotation) % (2 * Math.PI);
                    if (pointerAngle < 0) pointerAngle += 2 * Math.PI;
                    
                    const winnerIndex = Math.floor(pointerAngle / arcSize);
                    const winnerName = names[winnerIndex];
                    const winnerEmoji = cuteEmojis[winnerIndex % cuteEmojis.length];

                    playSound('win');
                    fireConfetti();
                    
                    showModal(`
                        <div class="flex flex-col items-center">
                            <div class="text-xl font-bold text-gray-700 mb-3">æ­å–œï¼æŒ‡é‡æŒ‡å‘äº†ï¼š</div>
                            <div class="text-4xl font-black text-indigo-600 animate-pop">ğŸ‰ ${winnerEmoji} ${winnerName} ğŸ‰</div>
                        </div>
                    `);
                    addToHistory(`ğŸ¯ ${winnerEmoji} ${winnerName}`);
                }
            }
            
            requestAnimationFrame(animate);
        }

        // View Switching
        function showSingleView() {
            singleView.classList.remove('hidden');
            singleView.classList.add('flex');
            groupView.classList.add('hidden');
            groupView.classList.remove('flex');
            wheelView.classList.add('hidden');
            wheelView.classList.remove('flex');
        }

        function showGroupView() {
            singleView.classList.add('hidden');
            singleView.classList.remove('flex');
            groupView.classList.remove('hidden');
            groupView.classList.add('flex');
            wheelView.classList.add('hidden');
            wheelView.classList.remove('flex');
        }
        
        function showWheelView() {
            singleView.classList.add('hidden');
            singleView.classList.remove('flex');
            groupView.classList.add('hidden');
            groupView.classList.remove('flex');
            wheelView.classList.remove('hidden');
            wheelView.classList.add('flex');
        }

        function copyGroups() {
            const cards = groupsContainer.querySelectorAll('.group-card');
            let text = "";
            cards.forEach((card, index) => {
                const names = Array.from(card.querySelectorAll('li')).map(li => li.innerText).join(', ');
                text += `ç¬¬ ${index + 1} çµ„: ${names}\n`;
            });
            
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(() => {
                    showModal("åˆ†çµ„çµæœå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼");
                }).catch(err => {
                    fallbackCopy(text);
                });
            } else {
                fallbackCopy(text);
            }
        }
        
        function fallbackCopy(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                showModal("åˆ†çµ„çµæœå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼");
            } catch (err) {
                showModal("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ã€‚");
            }
            document.body.removeChild(textArea);
        }

        // --- Confetti ---
        function fireConfetti() {
            var duration = 2 * 1000;
            var animationEnd = Date.now() + duration;
            var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 };
            var random = function(min, max) { return Math.random() * (max - min) + min; }

            var interval = setInterval(function() {
              var timeLeft = animationEnd - Date.now();
              if (timeLeft <= 0) return clearInterval(interval);
              var particleCount = 50 * (timeLeft / duration);
              confetti(Object.assign({}, defaults, { particleCount, origin: { x: random(0.1, 0.3), y: Math.random() - 0.2 } }));
              confetti(Object.assign({}, defaults, { particleCount, origin: { x: random(0.7, 0.9), y: Math.random() - 0.2 } }));
            }, 250);
        }

    </script>
</body>
</html>